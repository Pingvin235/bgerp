= Plugin Backup
:toc:

[[about]]
== About
The plugin allows making backup of the application code and data.

NOTE: You can see the plugin enabled in <<../../../kernel/install.adoc#demo, Demo System>>.

[[setup]]
== Setup
Enable the plugin in <<../../../kernel/setup.adoc#config-plugin, server config>>.
[source]
----
backup:enable=1

# offer for removing backups more than
#backup:cleanup.candidate.count.more.than=3
# offer for removing backups with DB more than
#backup:cleanup.candidate.db.count.more.than=3
----

[[setup-remote-ssh]]
=== Настройка удалённого бекапа по SSH
Все команды выполняются из-под *root*.
Для работы файловой системы достаточно SSH доступа к удалённому серверу.

На клиентской машине надо установить пакет *sshfs*.
[source]
----
apt install sshfs
----

Создаём каталог для монтирования:
[source]
----
mkdir /mnt/backup
----

Монтирование SSHFS выполняется с помощью команды:
[source]
----
sshfs [user@]host:[dir] mountpoint [options]
----

Пример:
[source]
----
sshfs root@backup.bgerp.org:/opt/BGERP/backup /mnt/backup
----

Чтобы увидеть точку монтирования удаленной файловой системы:
[source]
----
df -hT
----

Теперь вы можете использовать эту папку для того чтобы обмениваться файлами с сервером.
Если надо чтобы и другие пользователи могли получать доступ к этой папке, надо использовать опцию *allow_other*.
Она будет работать только если в файле `/etc/fuse.conf` присутствует опция *user_allow_other*.

Теперь можно монтировать:
[source]
----
sshfs -o allow_other root@backup.bgerp.org:/opt/BGERP/backup /mnt/backup
----

Отмонтировать файловую систему:
[source]
----
umount /mnt/backup
----

[[setup-remote-ssh-auto-mount]]
==== Автоматическое монтирование SSHFS
Создайте пару SSH-ключей, в результате выполнения команды будут созданы пара ключей (приватный ключ - `id_rsa` и публичный ключ - `id_rsa.pub`):
[source]
----
ssh-keygen
----

Для добавления ключа на удаленный сервер выполните следующую команду:
[source]
----
ssh-copy-id -i ~/.ssh/id_dsa.pub root@backup.bgerp.org
----

Проверить подключение к удаленному серверу с помощью SSH-ключа можно будет таким образом:
[source]
----
ssh root@backup.bgerp.org
----

NOTE: Под Windows SSH-ключи можно сгенерировать с помощью программ PuTTY или KiTTY.

После настройки авторизации на сервере по SSH-ключу, приступим к монтированию удаленной файловой системы в нашу локальную папку, для этого выполним следующую команду в терминале:
[source]
----
sshfs root@backup.bgerp.org:/opt/bgerp/backup /mnt/backup -o allow_other,default_permissions,IdentityFile=~/.ssh/id_rsa
----

[[usage]]
== Usage
Backup tool is available in menu *Administration / Backup*. There is content mode switch available.

image::_res/backup.png[width="800px"]

[square]
* Using drop-box backups can be created with or without DB content.
* Outdated backups can be removed using a button in the top-left corner of table. How many last backups are preserved from removing is <<setup, configured>>.
* Buttons in right table column allow restoring from backups. The application is automatically restarted after that.

