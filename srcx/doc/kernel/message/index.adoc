= Messages
:toc:
:toclevels: 4

[[about]]
== About
Приложение позволяет организовать обмен различными типами сообщений с привязкой их к процессам.
Таким образом процесс хранит всю историю связанных с ним коммуникаций с клиентами и между сотрудниками,
давая возможность легко восстановить ход событий и производить весь обмен из интерфейса программы.

drawio:_res/messages.drawio[]

В ядре поддерживаются сообщения типа Звонок, Заметки (Комментарии). Дополнительные типы сообщений предоставляются плагинами.

Система сообщений позволяет организовать обмен информации централизованным образом, исключая персональные контакты через отдельные аккаунты
E-Mail, телефоны и т.п.. Процесс может легко быть передан иному исполнителю и всю информацию по нему доступна всем и всегда.

Сообщения E-Mail могут быть использованы для коммуникации двух BGERP между собой. В каждой из них сообщения будут привязаны к своему процессу,
имеющих собственных исполнителей.

[[setup]]
== Setup
Для настройки сообщений создать отдельную <<../../kernel/setup.adoc#config, конфигурацию>>, включаемую в основную посредством инклуда.

Following settings should be done in the configuration.

[[setup-type]]
=== Типы
Типы сообщения настраиваются в конфигурации, одна или несколько записей вида:
----
messageType.<id>.title=<title>
messageType.<id>.class=<messageTypeClassName>
----
Где:
[square]
* *<id>* - уникальный числовой идентификатор типа сообщения, не должен меняться впоследствии;
* *<title>* - наименование типа сообщения;
* *<messageTypeClassName>* - имя класса-обработчика сообщений.

Опциональные параметры:
----
# не информировать о необработанных сообщениях данного типа
messageType.<id>.unprocessedMessageNotify=0
# do not check empty subject on saving
messageType.<id>.check.empty.subject=0
----

Остальные параметры различаются для разных видов сообщений.

Для типа сообщения могут быть указаны один или несколько режимов поиска:
----
messageType.<id>.search.<searchModeId>.title=<title>
messageType.<id>.search.<searchModeId>.class=<searchModeClassName>
----
Где:
[square]
* *<searchModeId>* - уникальный числовой идентификатор режима поиска, начиная с 1;
* *<title>* - наименование режима поиска;
* *<searchModeclassName>* - имя класса, реализующего режим поиска.

Первый режим поиска применяется по-умолчанию при открытии сообщения для обработки.

Необязателен к указанию и класс, сохраняющий контакт.

----
messageType.<id>.saver.class=<saverClassName>
----

На скриншоте цифрой 1 изображены режимы поиска, 2 - режимы сохранения контакта.

image::_res/message_process.png[]

Режимы поиска и сохранения могут быть специфичны для типа сообщения.
Search modes, marked as *Auto* are automatically and parallel running when a message is opened.

[[setup-type-search]]
==== Режимы поиска
[cols="a,a", options="header"]
|===

|Значение <searchModeClassName>, что ищет
|Конфигурация и пример

|:hardbreaks:
*MessageTypeSearchCustomerByTitle*
Контрагента по наименованию, для любого типа сообщения.

image::_res/i0111.png[]
|:hardbreaks:
Нет дополнительных параметров.
Пример:
----
messageType.1.search.2.title=Customer by Title
messageType.1.search.2.class=MessageTypeSearchCustomerByTitle
----

|:hardbreaks:
*MessageTypeSearchEmail*
*Auto*
Поиск контрагента по Email для типа сообщения Email.
|:hardbreaks:
Нет дополнительных параметров.
Пример:
----
messageType.1.search.1.title=Customer by EMail
messageType.1.search.1.class=MessageTypeSearchEmail
----

|:hardbreaks:
*MessageTypeSearchCall*
*Auto*
Поиск контрагента в базе BGERP по номеру телефона звонящего для типа сообщения Call. Поиск производится по точному совпадению.
|:hardbreaks:
----
messageType.<id>.search.<searchModeId>.title=<title>
messageType.<id>.search.<searchModeId>.class=MessageTypeSearchCall
messageType.<id>.search.<searchModeId>.commands=<commands>
# необязательный параметр
messageType.<id>.search.<searchModeId>.expressionNumberPreprocess=<jexl>
----
Где:
[square]
* *<commands>* - команды разделённые точкой с запятой, в данный момент поддержана *customerByPhoneParam:<paramIds>*, где *<paramIds>* - коды параметров типа "телефон" в биллинге через запятую;
* *<jexl>* - <<../extension.adoc#jexl, JEXL>> выражение для предобработки номера перед поиском с его использованием, исходный номер передаётся переменной *numberFrom*.

Пример:
----
messageType.1.search.1.title=Customer by Phone
messageType.1.search.1.class=MessageTypeSearchCall
messageType.1.search.1.commands=customerByPhoneParam:10
messageType.1.search.1.expressionNumberPreprocess=if( numberFrom.length() == 11 ){ numberFrom = numberFrom.substring(1)}; return numberFrom;
----

// DO NOT TRANSLATE modes for BGBilling Plugin!!!
include::../../plugin/bgbilling/message_search_modes.adocf[]
|===

[[setup-type-saver]]
==== Режимы сохранения
[cols="a,a", options="header"]
|===

|Значение <saverClassName>, что делает
|Конфигурация и пример

|:hardbreaks:
*MessageTypeContactSaverEmail*
Сохранение EMail в параметр типа "email" контрагента. Возможно сохранение домена либо только EMail а.
|:hardbreaks:
----
messageType.<id>.saver.class=MessageTypeContactSaverEmail
messageType.<id>.saver.paramId=<paramId>
----
Где:
[square]
* *<paramId>* - код параметра контрагента типа "EMail".

Пример:
----
messageType.1.saver.class=MessageTypeContactSaverEmail
messageType.1.saver.paramId=27
----

|:hardbreaks:
*MessageTypeContactSaverPhone*
Сохранение телефона в параметр типа "phone" контрагента. Возможно сохранение домена либо только EMail а.
|:hardbreaks:
----
messageType.<id>.saver.class=MessageTypeContactSaverPhone
messageType.<id>.saver.paramId=<paramId>
----
Где:
[square]
* *<paramId>* - код параметра понтрагента типа "Phone".

Пример:
----
messageType.1.saver.class=MessageTypeContactSaverPhone
messageType.1.saver.paramId=37
----

// DO NOT TRANSLATE modes for BGBilling Plugin!!!
include::../../plugin/bgbilling/message_save_modes.adocf[]
|===

[[setup-type-note]]
==== Type Note
*<messageTypeClassName>=MessageTypeNote*

Used for appending process notes.

image::_res/message_notes.png[width="800"]

Addidtional optional settings:
----
messageType.<id>.create.unread=1
----

Allows to create notes as unread.

Example of configuration:
----
messageType.100.title=Note
messageType.100.class=MessageTypeNote
----

[[setup-type-call]]
==== Type Call
*<messageTypeClassName>=MessageTypeCall*

Дополнительные необязательные параметры:
----
messageType.<id>.offerNumberFromParamId=<offerNumberFromParamId>
messageType.<id>.autoNumberRegister=<autoNumberRegister>
----
Где:
[square]
* *<offerNumberFromParamId>* - код текстового параметра пользователя, содержащий номер, предлагаемый к занятию по-умолчанию.
* *<autoNumberRegister>* - 0, to disable automatic registering user number on login.

Тип сообщения представляет из себя звонок, который обрабатывается оператором.
Для данного типа сообщения в оснастке <<#usage-queue, обработки>> сообщений отображается поле занятия номера. Строго говоря, это означает,
что в системе может быть зарегистрирован только один тип сообщения Call.

image::_res/i0109.png[]

As a call's supplier should be used <<../../plugin/asterisk/index.adoc#, Asterisk>> plugin or external <<../extension.adoc#run-http, HTTP requests>>.

[[setup-type-other]]
==== Other Text Types
The following plugins provide support for different text message types:
[square]
* <<../../plugin/msg/email/index.adoc#, E-Mail>>
* <<../../plugin/feedback/index.adoc#, Feedback>>
* <<../../plugin/bgbilling/index.adoc#helpdesk, BGBilling>> HelpDesk
* <<../../plugin/slack/index.adoc#, Slack>>

[[setup-tag]]
=== Tags
Colored message tags <<usage-process-tag, allow>> to separate messages in process tab. Example of configuration:
[square]
----
tag.1.title=Access
tag.1.color=red
tag.2.title=Requirements
tag.2.color=green
tag.3.title=TODO
tag.3.color=magenta
----

[[setup-possible-process]]
=== Possible Processes
NOTE: You can see a sample configurations in <<../install.adoc#demo, Demo System>>. For doing that open the message with subject
*Kernel Message Possible Process Unprocessed message* in <<#usage-queue, queue>>. Server configuration with Possible Processes for that has the name *Kernel Message Possible Process*.

To configure <<usage-queue-possible-process, Possible Processes>> to be found during message processing add to configuration following blocks:
----
message.possible.process.<id>.class=<class>
message.possible.process.<id>.color=<color>
----

Where:
[square]
* *<id>* - unique block's numeric ID, found processes are sorted by the IDs
* *<color>* - optional HTML color for table rows with found processes
* *<class>* - search type, one of the following values:
** *MessagePossibleProcessSearchMessageFrom* - processes with messages from the same *from* address (E-Mail sender or calling number) as the processed message.
** *MessagePossibleProcessSearchFoundLinks* - processes with the same links as found for the processed message.
** *MessagePossibleProcessSearchFoundLinksCustomerAddressCity* - processes with a <<../setup.adoc#param-list, list>> parameter values, matching to city IDs of address parameter of found customers.
That type requires additional properties set:
*** *processCityParamId*, ID of the list parameter.
** *BGBillingMessagePossibleProcessSearchFoundLinksContractAddressCity* - processes with a <<../setup.adoc#param-list, list>> parameter values, matching to city IDs of address parameter of found contracts in BGBilling system. That type requires additional properties set:
*** *processCityParamId*, ID of the list parameter;
*** *contractAddressParamId.<billingId>*, ID of address parameter in BGBilling system with ID *<billingId>*.

NOTE: If no block is defined then a single ones with class *MessagePossibleProcessSearchMessageFrom* is added.

[[setup-scheduler]]
=== Scheduler
Получение новых сообщений и отправку созданных осуществляет класс *MessageExchange*,
настройте его запуск в <<../setup.adoc#scheduler, планировщике>>.

Дополнительные опциональные параметры конфигурации задачи:
[square]
* *messageTypeIds* - коды типов сообщений через запятую, для которых производить обмен.

[[usage]]
== Usage

[[usage-queue]]
=== Оснастка "Сообщения"
Доступна через оснастку *Сообщения*. Основное назначение - первичная обработка сообщений с привязкой к вновь созданным, либо существующим процессам.
В обработке нуждаются не все сообщения, в данный момент она используется для E-Mail ов и <<#setup-type-call, звонков>>.
Обработка звонка открывается автоматически, E-Mail ы необходимо открывать в оснастке вручную.

NOTE: Уведомление о количестве необработанных сообщений выводится в области <<../interface.adoc#notifications, уведомлений>>.

Сообщение считается обработанным после того, как к нему привязан процесс. Помимо этого сообщение можно удалить.
В выпадающем списке можно выбрать фильтр по типу сообщений. В квадратных скобках рядом с типом отображается число необработанных сообщений каждого типа.

image::_res/messages.png[width="800"]

При клике по строке открывается обработка сообщения, внешний вид может быть следующим для звонка (снимок уже использовался выше).

image::_res/message_process.png[]

Либо для E-Mail.

image::_res/message_process_email.png[width="800"]

[[usage-queue-possible-process]]
In the left bottom area during message processing are shown <<setup-possible-process, possible processes>>, that can be assinged for the message using *set* links.

image::_res/message_process_possible_process.png[width="800"]

[[usage-process]]
=== Работа в процессе
Отображение вкладки сообщений должно быть настроено в <<../process/index.adoc#config-messages, конфигурации типа процесса>>.

image::_res/process_messages.png[]

Для создания сообщения в рамках процесса используйте кнопку *Создать*.

[[usage-process-tag]]
Доступен фильтр по сообщениям со вложениями и <<setup-tag, тегам>>.
Теги позволяют маркировать каждое сообщение определёнными метками, позволяющими их позже легко найти, например: "TODO", "Реквизиты".

Кнопка *M* рядом с каждым сообщением вызывает всплывающее меню с операциями:
[square]
* *Вкл./выкл. разрывы строк* - перенос длинных строк в сообщениях либо отображение скроллинга;
* *Теги* - установить теги на выбранное сообщение.
* *Изменить процесс на* - привязать сообщение к другому процессу:
** *Другой существующий* - по коду уже существующего процесса;
** *Независимую копию текущего* - создаётся новый процесс, копия текущего, в него копируются все привязки;
** *Зависящую копию текущего* - создаётся новый процесс, копия текущего и <<../process/index.adoc#usage-related-process, привязанный к нему с типом processDepend>>;
** *Порождённую копию текущего*  - создаётся новый процесс, копия текущего и <<../process/index.adoc#usage-related-process, привязанный к нему с типом processMade>>;
** *Ссылаемую копию текущего* - создаётся новый процесс, копия текущего и <<../process/index.adoc#usage-related-process, привязанный к нему с типом processLink>>.
* *Ответить* - создать новое сообщение, являющееся ответом на выбранное и также привязанное к текущему процессу;
* *Редактировать* - редактировать сообщение, если тип поддерживает;
* *Удалить* - удалить сообщение, если тип поддерживает.

Пометку процессов с новыми сообщениями можно <<../process/processing.adoc#, реализовать>> переключением статуса процесса по событию поступления сообщения.


